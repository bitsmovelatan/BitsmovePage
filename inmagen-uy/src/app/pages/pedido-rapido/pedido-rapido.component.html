<div class="pedido-rapido-container">
  <div class="page-header">
    <h2>ðŸ¤– Asistente RÃ¡pido de Pedidos con IA</h2>
    <p>Escribe tu pedido con tus propias palabras y dÃ©janos procesar lo que necesitas</p>
    <p class="subtitle-regions">
      <span>ðŸ•Ž Comida JudÃ­a</span>
      <span>ðŸ‡ºðŸ‡¾ Comida Uruguaya</span>
      <span>ðŸ‡»ðŸ‡ª Comida Venezolana</span>
      <span>ðŸ‡²ðŸ‡½ Comida Mexicana</span>
      <span>ðŸ‡®ðŸ‡¹ Comida Italiana</span>
    </p>
  </div>
  
  <!-- Formulario de entrada -->
  <div class="input-section" *ngIf="!mostrarResultados">
    <textarea 
      [(ngModel)]="textoUsuario" 
      rows="5" 
      placeholder="Ejemplo: 'Quiero 2 hallacas venezolanas, 3 cachapas, un asado uruguayo, 4 tacos mexicanos y una pizza italiana'"
      [disabled]="cargando"
      class="pedido-textarea"
    ></textarea>
    
    <button 
      (click)="procesarTexto()" 
      [disabled]="cargando || !textoUsuario.trim()"
      class="btn-primary">
      <mat-icon *ngIf="cargando">hourglass_empty</mat-icon>
      {{ cargando ? 'Procesando con Gemini AI...' : 'ðŸš€ Procesar Pedido con IA' }}
    </button>
  
    <p *ngIf="error" class="error-message">
      <mat-icon>error_outline</mat-icon>
      {{ error }}
    </p>
  </div>

  <!-- Resultados de validaciÃ³n -->
  <div class="resultados-section" *ngIf="mostrarResultados && !cargando">
    <div class="resultados-header">
      <h3>
        <mat-icon>checklist</mat-icon>
        Productos Identificados
      </h3>
      <button class="btn-secondary" (click)="nuevoPedido()">
        <mat-icon>refresh</mat-icon>
        Nuevo Pedido
      </button>
    </div>

    <!-- Lista de productos validados -->
    <div class="productos-lista">
      <div 
        *ngFor="let vp of productosValidados" 
        class="producto-card"
        [class.validated]="vp.validation.found"
        [class.not-found]="!vp.validation.found"
        [class.added]="vp.addedToCart">
        
        <!-- Producto encontrado -->
        <div class="producto-content" *ngIf="vp.validation.found && vp.validation.product">
          <div class="producto-image">
            <img [src]="vp.validation.product.imageUrl" [alt]="vp.validation.product.name">
            <div class="similarity-badge" [class]="getSimilarityClass(vp.validation.similarity)">
              <mat-icon>{{ getSimilarityIcon(vp.validation.similarity) }}</mat-icon>
            </div>
          </div>

          <div class="producto-info">
            <div class="producto-header">
              <h4>{{ vp.validation.product.name }}</h4>
              <span class="precio">{{ vp.validation.product.price }}</span>
            </div>
            
            <p class="producto-descripcion">{{ vp.validation.product.description }}</p>
            
            <div class="producto-meta">
              <span class="cantidad-badge">
                <mat-icon>shopping_basket</mat-icon>
                Cantidad: {{ vp.original.cantidad }}
              </span>
              <span class="region-badge" [attr.data-region]="vp.validation.product.region">
                <mat-icon>public</mat-icon>
                {{ getRegionDisplay(vp.validation.product.region) }}
              </span>
              <span class="categoria-badge">{{ vp.validation.product.category }}</span>
              <span *ngIf="vp.validation.product.glutenFree" class="gluten-free-badge">
                <mat-icon>check_circle</mat-icon>
                Sin Gluten
              </span>
            </div>

            <p class="notas" *ngIf="vp.original.notas">
              <mat-icon>note</mat-icon>
              <strong>Nota:</strong> {{ vp.original.notas }}
            </p>

            <div class="similarity-info" *ngIf="vp.validation.similarity && vp.validation.similarity < 1">
              <mat-icon>info</mat-icon>
              <small>
                Interpretado desde: "{{ vp.original.nombreProducto }}" 
                ({{ (vp.validation.similarity * 100).toFixed(0) }}% coincidencia)
              </small>
            </div>
          </div>

          <div class="producto-actions">
            <button 
              class="btn-add-cart"
              (click)="agregarAlCarrito(vp)"
              [disabled]="vp.addedToCart"
              [matTooltip]="vp.addedToCart ? 'Ya agregado al carrito' : 'Agregar al carrito'">
              <mat-icon>{{ vp.addedToCart ? 'check' : 'add_shopping_cart' }}</mat-icon>
              {{ vp.addedToCart ? 'Agregado' : 'Agregar' }}
            </button>
          </div>
        </div>

        <!-- Producto NO encontrado - Mostrar sugerencias -->
        <div class="producto-content not-found-content" *ngIf="!vp.validation.found">
          <div class="not-found-header">
            <mat-icon class="warning-icon">help_outline</mat-icon>
            <div>
              <h4>Producto no identificado</h4>
              <p>Buscaste: <strong>"{{ vp.original.nombreProducto }}"</strong></p>
              <p class="cantidad-info">Cantidad solicitada: {{ vp.original.cantidad }}</p>
              <p class="notas" *ngIf="vp.original.notas">Nota: {{ vp.original.notas }}</p>
            </div>
          </div>

          <div class="sugerencias" *ngIf="vp.validation.suggestions && vp.validation.suggestions.length > 0">
            <p class="sugerencias-titulo">
              <mat-icon>lightbulb</mat-icon>
              Â¿Te refieres a alguno de estos?
            </p>
            <div class="sugerencias-lista">
              <div 
                *ngFor="let sugerencia of vp.validation.suggestions" 
                class="sugerencia-card"
                (click)="usarSugerencia(vp, sugerencia)">
                <img [src]="sugerencia.imageUrl" [alt]="sugerencia.name" class="sugerencia-image">
                <div class="sugerencia-info">
                  <strong>{{ sugerencia.name }}</strong>
                  <span class="sugerencia-precio">{{ sugerencia.price }}</span>
                </div>
                <mat-icon>arrow_forward</mat-icon>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Acciones globales -->
    <div class="acciones-globales">
      <button 
        class="btn-add-all"
        (click)="agregarTodosAlCarrito()"
        [disabled]="!hasValidProductsToAdd()">
        <mat-icon>add_shopping_cart</mat-icon>
        Agregar Todos los VÃ¡lidos al Carrito
      </button>
      
      <button 
        class="btn-view-cart"
        [routerLink]="['/cart']">
        <mat-icon>shopping_cart</mat-icon>
        Ver Carrito
      </button>
    </div>
  </div>
</div>
